steps:
- name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  entrypoint: bash
  args:
    - ./scripts/update_version
- name: gcr.io/cloud-builders/gcloud
  entrypoint: 'bash'
  args: [ '-c', "gcloud secrets versions access latest --secret=github-token-access --format='get(payload.data)' | tr '_-' '/+' | base64 -d > token.txt" ]
- name: 'gcr.io/$PROJECT_ID/github'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    set -e
    gh auth login --with-token < token.txt
    gh auth status
# TODO: (mtauseeq) use build variable to replace name and email, Also use build variables to replace new branch name
- name: gcr.io/cloud-builders/git
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    set -e
    git status
    git branch -a
    export git_branch_name=npm_veriosn_$(cat version.bzl | grep DF_VERSION | awk '{ print $3 }' | sed "s/\"//g")
    git checkout -b $git_branch_name
    git config user.name Tuseeq1
    git config user.email mtauseeq@google.com
    git remote set-url origin https://Tuseeq1:$(cat token.txt)@github.com/dataform-co/dataform.git
    git add version.bzl
    git commit -m "Update the npm package version"
    git push origin $git_branch_name
    git status 
- name: 'gcr.io/$PROJECT_ID/github'
  args: ['pr', 'create', '-t', '"Publish a new NPM versions"', '-b', '"Pull request body"', '-B', 'npm-package-automation', '-H', '$git_branch_name' ,'--dry-run']