import Documentation from "../../_documentation";

export default ({children}) => <Documentation title="Building incremental tables">{children}</Documentation>;

# Introduction

Incremental tables allow you build a table incrementally, by only inserting data that has not yet been processed.

# Purposes

## Append only for performance

TODO

## Micro-batching for latency

TODO(Cover reducing downstream latency with microbatches)

## Creating daily snapshots

TODO

# Incremental table concepts

## Where clause

## Table descriptors

## Protecting tables from data loss

# Example: timestamp based incremental tables

## Table partitioning (BigQuery)

## Table partitioning (Redshift)

## Example: creating daily snapshots

# OLD

In order to define an incremental table we must set the `type` of the query to `"incremental"`, and provide a where clause.

For example, if you have a timestamp field in a source table called `ts`, then you can provide a where statement that means only rows that are newer than the latest value value of `ts` in our output table. The `where` function should be used inline as part of a query.

<p>
<div class="bp3-callout bp3-icon-info-sign bp3-intent-warning" markdown="1">
When using incremental tables, you must describe all the columns in the table, so that the correct insert statements can be generated.
</div>
</p>

```sql
/*js
type("incremental");
where(`ts > (select max(ts) from ${self()}`);
descriptor("ts", "a", "b");
*/
select ts, a, b from sourcetable
```

Incremental tables automatically produce the necessary `create table` and `insert` statements.

For the above example, if the table does not exist the the following statement will be run:

```sql
create or replace table dataform.incrementalexample as
  select ts, a, b
  from sourcetable
```

Subsequent runs will then run the following statement:

```sql
insert into dataform.incrementalexample (ts, a, b)
  select ts, a, b
  from sourcetable
  where ts > (select max(ts) from dataform.incrementaltable)
```

It's important to note that incremental tables MUST specifically list selected fields, so that the insert statement can be automatically generated.

The following would not work:
```sql
--js type("incremental");
select * from sourcetable
```
